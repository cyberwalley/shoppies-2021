
import { useState, useEffect } from "react";
import {Tabs, Card, Layout, Badge} from '@shopify/polaris';
import {MovieCard} from '../MovieCard'
import {EmptyStates} from '../EmptyStates'
import {Modals} from '../Modals'

export const Tab = ({
  movies,
  openModal,
}) => {
  const [selected, setSelected] = useState(0);
  const [movieId, setMovieId] = useState();
  const [modalContent, setModalContent] = useState();
  const [modal, setModal] = useState(false);
  const [nominatedMovieItems, setNominatedMovieItems] = useState([]);

  const handleModalChange = () => setModal(!modal);

  const apiSettings = {
    apiURL: "https://www.omdbapi.com/",
    apiKey: "dc6083ad",
    contentType: "movie",
  };

  const movieDataURL = `${apiSettings.apiURL}?type=${apiSettings.contentType}&apikey=${apiSettings.apiKey}`;

    //Get more data for more movie details. This call requires a movie ID to access more details about the movie
    useEffect(() => {
      async function fetchMovieData() {
        try {
          const data = await fetch(`${movieDataURL}&i=${movieId}`).then((res) =>
            res.json()
          );
  
          if (data) {
            const movieDetails = {
              title: data.Title,
              image: data.Poster,
              genre: data.Genre,
              rated: data.Rated,
              director: data.Director,
              awards: data.Awards,
              plot: data.Plot,
              released: data.Released,
            };
            console.log(movieDetails, 'megalooping')
            setModalContent(movieDetails);
          }
        } catch (error) {
          console.log(error);
        }
      }
  
      fetchMovieData();
    }, [movieDataURL, movieId]);

  //select Tab
  const handleTabChange = (selectedTabIndex) =>{
    setSelected(selectedTabIndex);
  };

  const handleNominate = (movie) => {
    setNominatedMovieItems((currentNominatedMovieItems) => [
      ...currentNominatedMovieItems,
      movie,
    ]);
  };

  const handleRemoveNomination = (movie) => {
    setNominatedMovieItems((currentNominatedMovieItems) =>
      currentNominatedMovieItems.filter(
        (nominatedMovie) => nominatedMovie.id !== movie.id
      )
    );
  };

  const movieListMarkup = movies.map((movie) => {
    return (
      <MovieCard key={movie.id} movie={movie} portrait={true} openModal={openModal}
      primaryAction = {{
        onAction: handleNominate,
        disabled: () => false,
        primary: () => true,
        label: 'Nominate',
      }}
      secondaryAction={{
        onAction: () => {
          setMovieId(movie.id); 
          setModal(true);
        },
        label: 'More info'
      }} />
    );
  });

 const nominationsMarkup = nominatedMovieItems.map((nominatedMovie) => {
    return (
      <MovieCard  movie={nominatedMovieItems} portrait={true} openModal={openModal}
      primaryAction = {{
        onAction: handleRemoveNomination,
        disabled: () => false,
        primary: () => true,
        label: 'Remove',
      }}
      secondaryAction={{
        onAction: () => {
          setMovieId(nominatedMovie.id); 
          setModal(true);
        },
        label: 'More info'
      }} />
    );
  }); 

  /* const nominationsMarkup = (
    <MovieCard  movie={nominatedMovieItems} portrait={true} openModal={openModal}
      primaryAction = {{
        onAction: handleRemoveNomination,
        disabled: () => false,
        primary: () => true,
        label: 'Remove',
      }}
      secondaryAction={{
        onAction: (movie) => {
          setMovieId(movie.id); 
          setModal(true);
        },
        label: 'More info'
      }} />
  ) */
  

  const tabs = [
    {
      id: 'movies-fitted-2',
      title: 'Movies',
      content: (
        <span>
          Movies{" "}
          <Badge status="new">{movies ? movies.length : 0}</Badge>
        </span>
      ),
      contentMarkUp:  movies.length > 0 ? movieListMarkup : <EmptyStates heading={'Search for your favorite movie by name.'} subheading={'The search result will appear here'} image='https://cdn.shopify.com/s/files/1/2506/6936/files/movies-empty-state.svg?v=1609784787' />,
      accessibilityLabel: 'Movies',
      panelID: 'movies-fitted-content-2',
    },
    {
      id: 'nomination-fitted-2',
      title: 'Nomination',
      content: (
        <span>
          Nomination{" "}
          <Badge status="new">{nominatedMovieItems ? nominatedMovieItems.length : 0}</Badge>
        </span>
      ),
      contentMarkUp:  nominatedMovieItems.length > 0 ? nominationsMarkup : <EmptyStates heading={'Nominate a movie and it will show up here.'} subheading={'The search result will appear here'} image='https://cdn.shopify.com/s/files/1/2506/6936/files/nomination-empty-state-2.svg?v=1609785285' />,
      panelID: 'nomination-fitted-Ccontent-2',
    },
  ];

  return (
    <div>
    <Tabs tabs={tabs} selected={selected} onSelect={handleTabChange} fitted>
      <Card.Section title={tabs[selected].title}>
      <Layout>
        {tabs[selected].contentMarkUp}
      </Layout>
      </Card.Section>
    </Tabs>
    <Modals open={modal} onClose={handleModalChange} content={modalContent} />
    </div>
  )
}
